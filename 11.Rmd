library(survival)
# Prepare survival variables
# Convert categorical variables into factors with labels
factorydata <- read.csv("C:/Users/16219/Desktop/factorydata.csv")
factorydata$tim_filled <- ifelse(is.na(factorydata$tim), 1095, factorydata$tim)
factorydata$fail_numeric <- as.numeric(factorydata$fail)
factorydata$role_cat <- factor(factorydata$role, levels = c(0, 1, 2), 
                      labels = c("Admin", "Maintenance", "Production"))
factorydata$smoke_cat <- factor(factorydata$smoke, levels = c(0, 1, 2), 
                       labels = c("Never", "Ex-Smoker", "Current"))
factorydata$sex_cat <- factor(factorydata$sex, levels = c(0, 1), 
# 
factorydata$fail_numeric <- as.numeric(factorydata$fail)


km_fit_role <- survfit(Surv(tim_filled, fail_numeric) ~ role_cat,data = factorydata)

# Plot KM curves
plot(km_fit_role,
     xlab = "Time (Days)",
     ylab = "Survival Probability",
     main = "Figure 1a: Kaplan-Meier Survival Curves by Job Role",
     lwd  = 2,
     col  = c("black", "red", "blue"))

legend("bottomleft",
       legend = levels(factorydata$role_cat),
       col    = c("black", "red", "blue"),
       lwd    = 2,
       bty    = "n")
# Log-rank test
logrank_role <- survdiff(Surv(tim_filled, fail_numeric) ~ role_cat, data = factorydata)
print("--- Log-rank Test: Job Role ---")
print(logrank_role)
# This creates a new categorical variable from the continuous one
quantiles <- quantile(factorydata$yrswork, probs = seq(0, 1, 0.25))
factorydata$yrswork_cat <- cut(factorydata$yrswork,
                               breaks = quantiles,
                               include.lowest = TRUE,
                               labels = c("Q1 (Shortest)", "Q2", "Q3", "Q4 (Longest)"))

# Fit KM model for Years Worked
km_fit_yrs <- survfit(Surv(tim_filled, fail_numeric) ~ yrswork_cat, data = factorydata)

# Log-rank test
logrank_yrs <- survdiff(Surv(tim_filled, fail_numeric) ~ yrswork_cat, data = factorydata)
print("--- Log-rank Test: Years Worked (Quartiles) ---")
print(logrank_yrs)

# Figure 1b: Plot KM for Years Worked
plot(km_fit_yrs, 
     col = c("green", "orange", "purple", "brown"), 
     lwd = 2, 
     xlab = "Time (Days)", 
     ylab = "Survival Probability", 
     main = "Figure 1b: KM Curves by Years Worked (Quartiles)")
legend("bottomleft",
       legend = levels(factorydata$yrswork_cat),
       col    = c("green", "orange", "purple", "brown"),
       lwd    = 2,
       bty    = "n")
# Univariable: Role
cox_uni_role <- coxph(Surv(tim_filled, fail_numeric) ~ role_cat, data = factorydata)
sum_uni_role <- summary(cox_uni_role)
res_uni_role <- cbind(
  HR = exp(coef(cox_uni_role)),
  exp(confint(cox_uni_role)),
  P_val = sum_uni_role$coefficients[, "Pr(>|z|)"]
)
# Univariable: Years Worked 
cox_uni_yrs <- coxph(Surv(tim_filled, fail_numeric) ~ yrswork, data = factorydata)
sum_uni_yrs <- summary(cox_uni_yrs)
res_uni_yrs <- cbind(
  HR = exp(coef(cox_uni_yrs)),
  exp(confint(cox_uni_yrs)),
  P_val = sum_uni_yrs$coefficients[, "Pr(>|z|)"]
)
table_uni <- rbind(res_uni_role, res_uni_yrs)

print(round(table_uni, 3))

# Model 1 (Main Effects): Adjusting for Age, Sex, Smoke
model_main <- coxph(Surv(tim_filled, fail_numeric) ~ role_cat + yrswork + age + sex + smoke, data = factorydata)
sum_main <- summary(model_main)

res_main <- cbind(
  HR = exp(coef(model_main)),
  exp(confint(model_main)),
  P_val = sum_main$coefficients[, "Pr(>|z|)"]
)

# Model 2 (Interaction): Testing role * yrswork
model_int <- coxph(Surv(tim_filled, fail_numeric) ~ age + sex + smoke + role_cat * yrswork, data = factorydata)
sum_int <- summary(model_int)

res_int <- cbind(
  HR = exp(coef(model_int)),
  exp(confint(model_int)),
  P_val = sum_int$coefficients[, "Pr(>|z|)"]
)

print("Model 1 (Main Effects):")
print(round(res_main, 3))
print("Model 2 (Interaction):")
print(round(res_int, 3))
# AIC and BIC Calculation
## AIC / BIC / logLik
aic_main <- AIC(model_main)
aic_int  <- AIC(model_int)

bic_main <- BIC(model_main)
bic_int  <- BIC(model_int)

loglik_main <- as.numeric(logLik(model_main))
loglik_int  <- as.numeric(logLik(model_int))

## Calculate LRT p value(model_main vs model_int)
lr_stat <- 2 * (loglik_int - loglik_main)
df_diff <- attr(logLik(model_int), "df") - attr(logLik(model_main), "df")
lrt_p   <- 1 - pchisq(lr_stat, df = df_diff)

##Draw the table
table_select <- data.frame(
  Model      = c("Model 1: Main effects", "Model 2: Interaction"),
  AIC        = c(aic_main, aic_int),
  BIC        = c(bic_main, bic_int),
  LogLik     = c(loglik_main, loglik_int),
  LRT_p_vs_Main = c(NA, lrt_p)
)

table_select[, 2:5] <- round(table_select[, 2:5], 3)


print(table_select)
# Proportional Hazards (PH) Assumption Test (Schoenfeld Residuals)
ph_test <- cox.zph(model_main)
print("--- Proportional Hazards Assumption Test ---")
print(ph_test)

par(mfrow = c(3, 3)) # Create a 3x3 grid

# Plot all variables
# df=2 degrees of freedom means it will check if it plots correctly per variable


plot(ph_test, main = "Schoenfeld Residuals")

# Reset layout
par(mfrow = c(1, 1))


